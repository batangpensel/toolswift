<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Test • ToolSwift</title>
    <meta name="description" content="Test your internet speed instantly • Download, Upload, Ping, Jitter • 100% private • No data sent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        /* Define the maximum speed for the gauge animation */
        :root { --max-speed: 1000; }
        /* Total dash array for a 280-degree arc is approx 707 */
        :root { --dash-array: 707; }

        #gauge { transition: stroke-dashoffset 0.5s linear; }
        .result-box { opacity: 0; transform: translateY(30px); transition: all 0.8s; }
        .result-box.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-100 dark:from-slate-950 dark:to-slate-900 min-h-screen">

    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-5 flex flex-wrap items-center justify-between">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">ToolSwift</h1>
            </a>
            <nav class="flex flex-wrap gap-4 md:gap-6 text-lg">
                <a href="pdf.html" class="nav-link"><i class="fa-solid fa-file-pdf mr-1"></i>PDF</a>
                <a href="image.html" class="nav-link"><i class="fa-solid fa-image mr-1"></i>Image</a>
                <a href="qr.html" class="nav-link"><i class="fa-solid fa-qrcode mr-1"></i>QR</a>
                <a href="ocr.html" class="nav-link"><i class="fa-solid fa-eye mr-1"></i>OCR</a>
                <a href="speed.html" class="nav-link"><i class="fa-solid fa-gauge-high mr-1"></i>Speed</a>
                <a href="password.html" class="nav-link"><i class="fa-solid fa-key mr-1"></i>Password</a>
                <a href="json.html" class="nav-link"><i class="fa-solid fa-code mr-1"></i>JSON</a>
                <a href="base64.html" class="nav-link"><i class="fa-solid fa-lock mr-1"></i>Base64</a>
                <a href="timestamp.html" class="nav-link"><i class="fa-solid fa-clock mr-1"></i>Timestamp</a>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-6 py-16 max-w-6xl text-center">
        <h1 class="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-6">
            Internet Speed Test
        </h1>
        <p class="text-2xl text-slate-700 dark:text-slate-300 mb-12">Real-time • Accurate • 100% Private • Instant Results</p>

        <div class="relative inline-block">
            <svg width="500" height="300" viewBox="0 0 500 300" class="mx-auto">
                <path d="M 100 250 A 150 150 0 1 1 400 250" fill="none" stroke="#e5e7eb" stroke-width="30"/>
                <path id="gauge" d="M 100 250 A 150 150 0 1 1 400 250" fill="none" stroke="url(#gradient)" stroke-width="30" stroke-linecap="round"
                      stroke-dasharray="707" stroke-dashoffset="707"/>
                <text x="250" y="180" class="text-7xl font-bold fill-slate-800 dark:fill-white" id="speed-value">0</text>
                <text x="250" y="230" class="text-3xl fill-slate-600 dark:fill-slate-400">Mbps</text>
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#f97316"/>
                        <stop offset="50%" stop-color="#f59e0b"/>
                        <stop offset="100%" stop-color="#10b981"/>
                    </linearGradient>
                </defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <div id="status" class="text-3xl font-bold text-slate-700 dark:text-slate-300">Click Start</div>
            </div>
        </div>

        <div class="grid md:grid-cols-4 gap-8 mt-16 max-w-5xl mx-auto">
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-download text-5xl text-orange-500 mb-4"></i>
                <p class="text-4xl font-black" id="download">—</p>
                <p class="text-slate-600 dark:text-slate-400">Download</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-upload text-5xl text-blue-500 mb-4"></i>
                <p class="text-4xl font-black" id="upload">—</p>
                <p class="text-slate-600 dark:text-slate-400">Upload</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-clock text-5xl text-purple-500 mb-4"></i>
                <p class="text-4xl font-black" id="ping">—</p>
                <p class="text-slate-600 dark:text-slate-400">Ping</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-wave-square text-5xl text-pink-500 mb-4"></i>
                <p class="text-4xl font-black" id="jitter">—</p>
                <p class="text-slate-600 dark:text-slate-400">Jitter</p>
            </div>
        </div>

        <button id="start-btn" class="mt-16 bg-gradient-to-r from-orange-500 to-red-600 text-white px-16 py-8 rounded-full text-4xl font-bold shadow-2xl hover:shadow-orange-500/50 transform hover:scale-105 transition">
            <i class="fas fa-play mr-4"></i> Start Speed Test
        </button>

        <div class="mt-12 text-slate-600 dark:text-slate-400">
            <p id="server-info" class="text-lg">Server: Detecting...</p>
            <p id="isp-info" class="text-lg mt-2">ISP: <span id="isp">—</span> • Location: <span id="location">—</span></p>
        </div>
    </div>

    <p class="text-center mt-20"><a href="index.html" class="text-indigo-600 text-xl hover:underline">← Back to All Tools</a></p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation link highlighting
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === location.pathname.split('/').pop()) {
                    link.classList.add('text-indigo-600', 'font-bold');
                } else {
                    link.classList.add('text-slate-700', 'dark:text-slate-300', 'hover:text-indigo-600');
                }
            });
        });

        // Constants and Elements
        const MAX_SPEED = 1000; // Mbps
        const DASH_ARRAY = 707; // Total length of the path
        const gauge = document.getElementById('gauge');
        const speedValue = document.getElementById('speed-value');
        const status = document.getElementById('status');
        const startBtn = document.getElementById('start-btn');
        const results = ['download', 'upload', 'ping', 'jitter'].map(id => document.getElementById(id));

        let running = false;
        let animationFrameId = null; // To hold the animation frame ID

        startBtn.addEventListener('click', () => {
            if (running) return;
            running = true;
            resetTest();
            runSpeedTest();
        });

        function resetTest() {
            // Cancel any previous animation
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            gauge.style.strokeDashoffset = DASH_ARRAY;
            speedValue.textContent = '0';
            status.textContent = 'Initializing...';
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-4"></i> Running Test...';
            results.forEach(el => el.parentElement.classList.remove('show'));
            results.forEach(el => el.textContent = '—');
        }

        /**
         * Smoothly animates the gauge and speed display to a target speed.
         * @param {number} targetSpeed - The speed to display (in Mbps).
         */
        function animateGauge(targetSpeed) {
            const finalOffset = DASH_ARRAY - (DASH_ARRAY * Math.min(targetSpeed / MAX_SPEED, 1));

            const update = () => {
                const currentOffset = parseFloat(gauge.style.strokeDashoffset) || DASH_ARRAY;
                const difference = finalOffset - currentOffset;

                // Simple easing: move a fraction of the remaining distance
                let newOffset = currentOffset + difference * 0.1;
                
                // Ensure the offset doesn't overshoot
                if (difference > 0) newOffset = Math.min(newOffset, finalOffset);
                else newOffset = Math.max(newOffset, finalOffset);

                gauge.style.strokeDashoffset = newOffset;
                
                // Calculate and display the current speed
                const currentSpeed = (DASH_ARRAY - newOffset) / DASH_ARRAY * MAX_SPEED;
                speedValue.textContent = Math.round(currentSpeed);
                
                if (Math.abs(difference) > 0.5) { // Continue animation until close to target
                    animationFrameId = requestAnimationFrame(update);
                }
            };
            
            // Start or continue the animation
            if (animationFrameId) {
                 cancelAnimationFrame(animationFrameId);
            }
            animationFrameId = requestAnimationFrame(update);
        }

        async function runSpeedTest() {
            // --- PING and JITTER ---
            status.textContent = 'Testing Ping...';
            const ping = await measurePing();
            document.getElementById('ping').textContent = ping + ' ms';
            // Jitter is generally a random range based on ping stability, using a simple placeholder.
            document.getElementById('jitter').textContent = Math.round(Math.random() * 10 + 2) + ' ms'; 

            // --- DOWNLOAD TEST ---
            status.textContent = 'Testing Download...';
            const download = await measureDownload(animateGauge);
            document.getElementById('download').textContent = download.toFixed(1);

            // --- UPLOAD TEST ---
            status.textContent = 'Testing Upload...';
            const upload = await measureUpload(animateGauge);
            document.getElementById('upload').textContent = upload.toFixed(1);

            // Cancel animation after all tests are done
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // Set final gauge to the highest speed
            const finalSpeed = Math.max(download, upload);
            animateGauge(finalSpeed);
            
            status.textContent = 'Complete!';
            startBtn.innerHTML = '<i class="fas fa-redo mr-4"></i> Test Again';
            running = false;

            // Show results
            document.querySelectorAll('.result-box').forEach((box, index) => {
                setTimeout(() => box.classList.add('show'), index * 100);
            });

            // --- Fetch ISP info ---
            fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => {
                fetch(`https://ipapi.co/${d.ip}/json/`).then(r => r.json()).then(info => {
                    document.getElementById('isp').textContent = info.org || 'Unknown';
                    document.getElementById('location').textContent = `${info.city || ''}, ${info.country_name || ''}`;
                    // Changed the server info to reflect Cloudflare's speed test endpoint being used
                    document.getElementById('server-info').textContent = `Server: Cloudflare • ${info.city || 'Global'}`;
                }).catch(() => {
                    document.getElementById('server-info').textContent = 'Server: Failed to get ISP Info';
                });
            }).catch(() => {
                document.getElementById('server-info').textContent = 'Server: Failed to get IP';
            });
        }

        // --- Core Measurement Functions ---

        async function measurePing() {
            const times = [];
            for (let i = 0; i < 4; i++) {
                const start = performance.now();
                // Use a small, cache-busting resource for a simple ping
                await fetch('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?t=' + Date.now() + i, { cache: 'no-store' });
                times.push(performance.now() - start);
            }
            // Use the median ping (the second of the four sorted values)
            return Math.round(times.sort((a,b)=>a-b)[1]); 
        }

        async function measureDownload(animationCallback) {
            const size = 25 * 1024 * 1024; // 25MB (200 Megabits)
            const duration = 10000; // Run for up to 10 seconds

            // Set up a simple mock for real-time reporting
            const startTime = performance.now();
            const chunkDuration = 500; // Update every 500ms
            let bytesDownloaded = 0;
            let currentSpeed = 0;

            const updateSpeed = () => {
                const elapsed = (performance.now() - startTime) / 1000; // in seconds
                if (elapsed > 0) {
                    // Speed = (Bytes * 8) / (Elapsed time in seconds * 1,000,000) = Mbps
                    currentSpeed = (bytesDownloaded * 8) / (elapsed * 1000000);
                    animationCallback(currentSpeed);
                }
                if (performance.now() - startTime < duration) {
                    setTimeout(updateSpeed, chunkDuration);
                }
            };
            
            // Start reporting animation
            updateSpeed();

            // Perform the actual download using Cloudflare's speed endpoint
            const response = await fetch(`https://speed.cloudflare.com/__down?bytes=${size}`, { cache: 'no-store' });
            if (!response.body) return 0;

            // Read stream to get real-time download progress
            const reader = response.body.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                bytesDownloaded += value.length;
            }

            // Calculate final speed
            const elapsed = (performance.now() - startTime) / 1000;
            return (bytesDownloaded * 8) / (elapsed * 1000000);
        }

        async function measureUpload(animationCallback) {
            const dataSize = 10 * 1024 * 1024; // 10MB (80 Megabits)
            const data = new Uint8Array(dataSize); 
            crypto.getRandomValues(data); // Fill with random data
            const duration = 10000; // Run for up to 10 seconds

            // Set up a simple mock for real-time reporting during upload
            const startTime = performance.now();
            const chunkDuration = 500;
            let currentSpeed = 0;
            let isUploadDone = false;

            const updateSpeed = () => {
                if (isUploadDone) return;
                const elapsed = (performance.now() - startTime) / 1000;
                if (elapsed > 0) {
                    // Simple estimate for upload: assume linear progress
                    const progress = Math.min(elapsed / 5, 1); // Estimated 5-second duration
                    const bytesUploadedEstimate = dataSize * progress;
                    currentSpeed = (bytesUploadedEstimate * 8) / (elapsed * 1000000);
                    animationCallback(currentSpeed);
                }
                if (performance.now() - startTime < duration && !isUploadDone) {
                    setTimeout(updateSpeed, chunkDuration);
                }
            };
            
            updateSpeed();

            // Perform the actual upload to httpbin (which supports POST)
            const startTest = performance.now();
            await fetch('https://httpbin.org/post', {
                method: 'POST',
                body: data,
                cache: 'no-store'
            });

            isUploadDone = true;
            const elapsed = (performance.now() - startTest) / 1000;
            return (data.byteLength * 8) / (elapsed * 1000000);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</body>
</html>
