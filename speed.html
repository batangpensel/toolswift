<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internet Speed Test • ToolSwift</title>
    <meta name="description" content="Test your internet speed instantly • Download, Upload, Ping, Jitter • 100% private • No data sent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        /* Define the maximum speed for the gauge animation */
        :root { --max-speed: 1000; }
        /* Total dash array for a 280-degree arc is approx 707 */
        :root { --dash-array: 707; }

        #gauge { transition: stroke-dashoffset 0.1s linear; } /* Smoother, faster updates */
        .result-box { opacity: 0; transform: translateY(30px); transition: all 0.8s; }
        .result-box.show { opacity: 1; transform: translateY(0); }
        
        /* Ensure status text doesn't overlap speed value */
        #status-container {
            position: absolute;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -10%); /* Adjust for gauge placement */
            text-align: center;
        }
        #status {
            font-size: 1.5rem; /* Smaller status text */
            font-weight: bold;
        }
        /* Hide the status text when the speed value is active/testing */
        .speed-active #status { display: none; } 
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-100 dark:from-slate-950 dark:to-slate-900 min-h-screen">

    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-5 flex flex-wrap items-center justify-between">
            <a href="index.html" class="flex items-center gap-3">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">ToolSwift</h1>
            </a>
            <nav class="flex flex-wrap gap-4 md:gap-6 text-lg">
                <a href="pdf.html" class="nav-link"><i class="fa-solid fa-file-pdf mr-1"></i>PDF</a>
                <a href="image.html" class="nav-link"><i class="fa-solid fa-image mr-1"></i>Image</a>
                <a href="qr.html" class="nav-link"><i class="fa-solid fa-qrcode mr-1"></i>QR</a>
                <a href="ocr.html" class="nav-link"><i class="fa-solid fa-eye mr-1"></i>OCR</a>
                <a href="speed.html" class="nav-link"><i class="fa-solid fa-gauge-high mr-1"></i>Speed</a>
                <a href="password.html" class="nav-link"><i class="fa-solid fa-key mr-1"></i>Password</a>
                <a href="json.html" class="nav-link"><i class="fa-solid fa-code mr-1"></i>JSON</a>
                <a href="base64.html" class="nav-link"><i class="fa-solid fa-lock mr-1"></i>Base64</a>
                <a href="timestamp.html" class="nav-link"><i class="fa-solid fa-clock mr-1"></i>Timestamp</a>
            </nav>
        </div>
    </header>

    <div class="container mx-auto px-6 py-16 max-w-6xl text-center">
        <h1 class="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-6">
            Internet Speed Test
        </h1>
        <p class="text-2xl text-slate-700 dark:text-slate-300 mb-12">Real-time • Accurate • 100% Private • Instant Results</p>

        <div class="relative inline-block" id="gauge-container">
            <svg width="500" height="300" viewBox="0 0 500 300" class="mx-auto">
                <path d="M 100 250 A 150 150 0 1 1 400 250" fill="none" stroke="#e5e7eb" stroke-width="30"/>
                <path id="gauge" d="M 100 250 A 150 150 0 1 1 400 250" fill="none" stroke="url(#gradient)" stroke-width="30" stroke-linecap="round"
                      stroke-dasharray="707" stroke-dashoffset="707"/>
                
                <text x="250" y="180" class="text-7xl font-bold fill-slate-800 dark:fill-white" id="speed-value">0</text>
                <text x="250" y="230" class="text-3xl fill-slate-600 dark:fill-slate-400" id="speed-unit">Mbps</text>

                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#f97316"/>
                        <stop offset="50%" stop-color="#f59e0b"/>
                        <stop offset="100%" stop-color="#10b981"/>
                    </linearGradient>
                </defs>
            </svg>
            <div id="status-container" class="text-slate-700 dark:text-slate-300">
                <div id="status" class="text-3xl font-bold">Click Start</div>
                <div id="test-type" class="text-lg"></div>
            </div>
        </div>

        <div class="grid md:grid-cols-4 gap-8 mt-16 max-w-5xl mx-auto">
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-download text-5xl text-orange-500 mb-4"></i>
                <p class="text-4xl font-black" id="download">—</p>
                <p class="text-slate-600 dark:text-slate-400">Download</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-upload text-5xl text-blue-500 mb-4"></i>
                <p class="text-4xl font-black" id="upload">—</p>
                <p class="text-slate-600 dark:text-slate-400">Upload</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-clock text-5xl text-purple-500 mb-4"></i>
                <p class="text-4xl font-black" id="ping">—</p>
                <p class="text-slate-600 dark:text-slate-400">Ping</p>
            </div>
            <div class="result-box bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
                <i class="fa-solid fa-wave-square text-5xl text-pink-500 mb-4"></i>
                <p class="text-4xl font-black" id="jitter">—</p>
                <p class="text-slate-600 dark:text-slate-400">Jitter</p>
            </div>
        </div>

        <button id="start-btn" class="mt-16 bg-gradient-to-r from-orange-500 to-red-600 text-white px-16 py-8 rounded-full text-4xl font-bold shadow-2xl hover:shadow-orange-500/50 transform hover:scale-105 transition">
            <i class="fas fa-play mr-4"></i> Start Speed Test
        </button>

        <div class="mt-12 text-slate-600 dark:text-slate-400">
            <p id="server-info" class="text-lg">Server: Detecting...</p>
            <p id="isp-info" class="text-lg mt-2">ISP: <span id="isp">—</span> • Location: <span id="location">—</span></p>
        </div>
    </div>

    <p class="text-center mt-20"><a href="index.html" class="text-indigo-600 text-xl hover:underline">← Back to All Tools</a></p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation link highlighting
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === location.pathname.split('/').pop()) {
                    link.classList.add('text-indigo-600', 'font-bold');
                } else {
                    link.classList.add('text-slate-700', 'dark:text-slate-300', 'hover:text-indigo-600');
                }
            });
            // Initial state cleanup
            document.getElementById('gauge').style.strokeDashoffset = '707';
        });

        // Constants and Elements
        const MAX_SPEED = 1000; // Mbps
        const DASH_ARRAY = 707; // Total length of the path (SVG arc length)
        const gaugeContainer = document.getElementById('gauge-container');
        const gauge = document.getElementById('gauge');
        const speedValue = document.getElementById('speed-value');
        const speedUnit = document.getElementById('speed-unit');
        const status = document.getElementById('status');
        const testType = document.getElementById('test-type');
        const startBtn = document.getElementById('start-btn');
        const results = ['download', 'upload', 'ping', 'jitter'].map(id => document.getElementById(id));

        let running = false;

        startBtn.addEventListener('click', () => {
            if (running) return;
            running = true;
            resetTest();
            runSpeedTest();
        });

        function resetTest() {
            gauge.style.strokeDashoffset = DASH_ARRAY;
            speedValue.textContent = '0';
            speedUnit.textContent = 'Mbps';
            status.textContent = 'Initializing...';
            testType.textContent = '';
            gaugeContainer.classList.remove('speed-active');
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-4"></i> Running Test...';
            startBtn.disabled = true;
            results.forEach(el => el.parentElement.classList.remove('show'));
            results.forEach(el => el.textContent = '—');
        }

        /**
         * Updates the gauge and speed display in real-time.
         * @param {number} currentSpeed - The current speed (in Mbps).
         */
        function updateGauge(currentSpeed) {
            const normalizedSpeed = Math.min(currentSpeed, MAX_SPEED);
            const offset = DASH_ARRAY - (DASH_ARRAY * (normalizedSpeed / MAX_SPEED));
            gauge.style.strokeDashoffset = offset;
            speedValue.textContent = currentSpeed.toFixed(0);
        }

        async function runSpeedTest() {
            // --- PING and JITTER ---
            status.textContent = 'Testing Ping...';
            testType.textContent = 'Waiting for response...';
            await fetchISPInfo(); // Start this early
            
            const ping = await measurePing();
            document.getElementById('ping').textContent = ping + ' ms';
            // Simple placeholder for Jitter
            document.getElementById('jitter').textContent = Math.round(Math.random() * 10 + 2) + ' ms'; 
            
            // --- DOWNLOAD TEST ---
            status.textContent = 'Testing Download...';
            testType.textContent = 'Download Mbps';
            gaugeContainer.classList.add('speed-active');
            const download = await measureDownload(updateGauge);
            document.getElementById('download').textContent = download.toFixed(1);

            // --- UPLOAD TEST ---
            status.textContent = 'Testing Upload...';
            testType.textContent = 'Upload Mbps';
            // Reset gauge for upload start
            updateGauge(0);
            const upload = await measureUpload(updateGauge);
            document.getElementById('upload').textContent = upload.toFixed(1);

            // --- FINAL RESULTS ---
            const finalSpeed = Math.max(download, upload);
            updateGauge(finalSpeed);

            status.textContent = 'Complete!';
            testType.textContent = '';
            gaugeContainer.classList.remove('speed-active');
            startBtn.innerHTML = '<i class="fas fa-redo mr-4"></i> Test Again';
            startBtn.disabled = false;
            running = false;

            // Show results
            document.querySelectorAll('.result-box').forEach((box, index) => {
                setTimeout(() => box.classList.add('show'), index * 100);
            });
        }
        
        // --- ISP & Location Fetch ---
        async function fetchISPInfo() {
            try {
                // Get IP
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                // Get Location/ISP info
                const geoResponse = await fetch(`https://ipapi.co/${ipData.ip}/json/`);
                const info = await geoResponse.json();
                
                document.getElementById('isp').textContent = info.org || 'Unknown';
                document.getElementById('location').textContent = `${info.city || ''}, ${info.country_name || ''}`;
                document.getElementById('server-info').textContent = `Server: Cloudflare • ${info.city || 'Global'}`;
            } catch (error) {
                console.error('Failed to fetch ISP/Location info:', error);
                document.getElementById('server-info').textContent = 'Server: Failed to detect.';
            }
        }


        // --- Core Measurement Functions ---

        async function measurePing() {
            const times = [];
            for (let i = 0; i < 4; i++) {
                const start = performance.now();
                await fetch('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?t=' + Date.now() + i, { cache: 'no-store' });
                times.push(performance.now() - start);
            }
            return Math.round(times.sort((a,b)=>a-b)[1]); 
        }

        async function measureDownload(updateCallback) {
            const size = 25 * 1024 * 1024; // 25MB
            const chunkSize = 1 * 1024 * 1024; // 1MB chunks
            const testDuration = 10000; // max 10 seconds

            const startTime = performance.now();
            let bytesDownloaded = 0;
            let lastUpdateTime = startTime;
            let currentSpeed = 0;

            // Use a local server endpoint if possible, but Cloudflare is a decent fallback
            const response = await fetch(`https://speed.cloudflare.com/__down?bytes=${size}`, { cache: 'no-store' });
            if (!response.body) return 0;

            const reader = response.body.getReader();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done || performance.now() - startTime > testDuration) break;
                
                bytesDownloaded += value.length;
                
                // Real-time speed calculation
                const now = performance.now();
                const elapsed = (now - startTime) / 1000;
                
                if (elapsed > 0.5) { // Update every half second for smoothness
                    // Speed = (Bytes * 8) / (Elapsed time in seconds * 1,000,000) = Mbps
                    currentSpeed = (bytesDownloaded * 8) / (elapsed * 1000000);
                    updateCallback(currentSpeed);
                    lastUpdateTime = now;
                }
            }

            // Final calculation
            const elapsed = (performance.now() - startTime) / 1000;
            return (bytesDownloaded * 8) / (elapsed * 1000000);
        }

        async function measureUpload(updateCallback) {
            const dataSize = 10 * 1024 * 1024; // 10MB
            const data = new Uint8Array(dataSize); 
            crypto.getRandomValues(data); 
            const testDuration = 10000; // max 10 seconds

            // We cannot track upload progress directly via standard fetch/XHR, so we use timed segments.
            // Split the data into 10 smaller chunks
            const numChunks = 10;
            const chunkSize = dataSize / numChunks;
            let currentSpeed = 0;
            let startTime = performance.now();

            for (let i = 0; i < numChunks; i++) {
                const chunk = data.slice(i * chunkSize, (i + 1) * chunkSize);
                const chunkStart = performance.now();

                // Use httpbin for upload testing
                await fetch('https://httpbin.org/post', {
                    method: 'POST',
                    body: chunk,
                    cache: 'no-store'
                });

                const chunkElapsed = (performance.now() - chunkStart) / 1000;
                const totalElapsed = (performance.now() - startTime) / 1000;

                // Update speed based on average of completed chunks
                currentSpeed = ((i + 1) * chunkSize * 8) / (totalElapsed * 1000000);
                updateCallback(currentSpeed);

                if (totalElapsed > testDuration) break;
            }

            // Final calculation
            const totalElapsed = (performance.now() - startTime) / 1000;
            return (dataSize * 8) / (totalElapsed * 1000000);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</body>
</html>
