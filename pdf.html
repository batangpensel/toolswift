<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Merger & Images → PDF - ToolSwift</title>
  <meta name="description" content="Merge PDFs and convert images to PDF — 100% in your browser, no upload."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://unpkg.com/downloadjs@1.4.8/download.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    .drag-over { border-color: #8b5cf6 !important; background: rgba(139,92,246,0.1); }
    .thumbnail { transition: all 0.3s; }
    .thumbnail:hover { transform: scale(1.08); }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-100 dark:from-slate-950 dark:to-slate-900 min-h-screen">
  <div id="root" class="max-w-5xl mx-auto p-6"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;
const { PDFDocument, PageSizes } = PDFLib;

const formatBytes = (bytes) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};

const App = () => {
  const [files, setFiles] = useState([]);           // File objects
  const [previews, setPreviews] = useState([]);     // thumbnail URLs
  const [isDragging, setIsDragging] = useState(false);
  const [isMerging, setIsMerging] = useState(false);
  const [error, setError] = useState("");
  const listRef = useRef();
  const fileInputRef = useRef();

  // Generate thumbnails
  useEffect(() => {
    const generatePreviews = async () => {
      const urls = await Promise.all(files.map(async (file) => {
        if (file.type.startsWith('image/')) {
          return URL.createObjectURL(file);
        }
        if (file.type === 'application/pdf') {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await PDFDocument.load(arrayBuffer);
          // Very lightweight first-page render using canvas (optional, but nice)
          return null; // we’ll show PDF icon instead
        }
        return null;
      }));
      setPreviews(urls);
    };
    generatePreviews();
  }, [files]);

  // Sortable
  useEffect(() => {
    if (listRef.current && files.length > 1) {
      Sortable.create(listRef.current, {
        animation: 200,
        handle: '.drag-handle',
        ghostClass: 'bg-purple-100',
        onEnd: (evt) => {
          const newFiles = [...files];
          const [moved] = newFiles.splice(evt.oldIndex, 1);
          newFiles.splice(evt.newIndex, 0, moved);
          setFiles(newFiles);
        }
      });
    }
  }, [files]);

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragging(false);
    const dropped = [...e.dataTransfer.files].filter(f => 
      f.type === "application/pdf" || f.type.startsWith("image/")
    );
    if (dropped.length === 0) {
      setError("Only PDF and image files are allowed.");
      return;
    }
    setFiles(prev => [...prev, ...dropped]);
  };

  const removeFile = (i) => {
    setFiles(files.filter((_, idx) => idx !== i));
    if (previews[i]) URL.revokeObjectURL(previews[i]);
  };

  const mergePDF = async () => {
    if (files.length === 0) return;
    setIsMerging(true);
    setError("");

    try {
      const pdfDoc = await PDFDocument.create();

      for (const file of files) {
        const arrayBuffer = await file.arrayBuffer();

        if (file.type === "application/pdf") {
          const srcPdf = await PDFDocument.load(arrayBuffer);
          const copiedPages = await pdfDoc.copyPages(srcPdf, srcPdf.getPageIndices());
          copiedPages.forEach(p => pdfDoc.addPage(p));
        } 
        else if (file.type.startsWith("image/")) {
          const isPng = file.type === "image/png";
          const imageBytes = new Uint8Array(arrayBuffer);
          const image = isPng 
            ? await pdfDoc.embedPng(imageBytes)
            : await pdfDoc.embedJpg(imageBytes);

          // Fit to A4 with nice margins
          const page = pdfDoc.addPage(PageSizes.A4);
          const { width, height } = page.getSize();
          const margin = 50;
          const availableWidth = width - 2 * margin;
          const availableHeight = height - 2 * margin;

          const scale = Math.min(
            availableWidth / image.width,
            availableHeight / image.height,
            1
          );

          const scaledWidth = image.width * scale;
          const scaledHeight = image.height * scale;

          page.drawImage(image, {
            x: (width - scaledWidth) / 2,
            y: (height - scaledHeight) / 2,
            width: scaledWidth,
            height: scaledHeight,
          });
        }
      }

      const pdfBytes = await pdfDoc.save();
      download(pdfBytes, 
        `ToolSwift_merged_${new Date().toISOString().slice(0,10)}.pdf`, 
        "application/pdf"
      );
    } catch (err) {
      console.error(err);
      setError("Merging failed: " + err.message);
    } finally {
      setIsMerging(false);
    }
  };

  const totalSize = files.reduce((sum, f) => sum + f.size, 0);

  return (
    <div className="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl p-8 md:p-12">
      <h1 className="text-5xl font-black text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
        PDF Merger & Images → PDF
      </h1>
      <p className="text-center text-xl text-slate-600 dark:text-slate-400 mb-10">
        100% private • Runs in your browser • No data leaves your device
      </p>

      <div
        onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
        onDragLeave={(e) => { e.preventDefault(); setIsDragging(false); }}
        onDrop={handleDrop}
        className={`border-4 border-dashed rounded-3xl p-16 text-center transition-all ${isDragging ? 'drag-over border-purple-500' : 'border-blue-400'}`}
      >
        <i className="fa-solid fa-cloud-arrow-up text-8xl text-blue-600 mb-6"></i>
        <p className="text-3xl font-bold mb-4">Drop PDF or image files here</p>
        <p className="text-xl text-slate-600 dark:text-slate-400">or</p>
        <label className="mt-6 inline-block px-10 py-5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl text-xl font-bold cursor-pointer hover:shadow-xl">
          Choose Files
          <input ref={fileInputRef} type="file" multiple accept=".pdf,image/*" className="hidden"
            onChange={(e) => e.target.files?.length && setFiles(prev => [...prev, ...e.target.files])}
          />
        </label>
      </div>

      {files.length > 0 && (
        <div className="mt-12">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-2xl font-bold">
              {files.length} file{files.length > 1 ? 's' : ''} ({formatBytes(totalSize)})
            </h3>
            <div>
              <button onClick={() => fileInputRef.current?.click()} className="mr-4 text-blue-600 hover:underline">
                <i className="fas fa-plus mr-2"></i>Add more
              </button>
              <button onClick={() => { setFiles([]); setPreviews([]); }} className="text-red-600 hover:underline">
                Clear all
              </button>
            </div>
          </div>

          <div ref={listRef} className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            {files.map((file, i) => (
              <div key={i} className="relative group thumbnail bg-slate-100 dark:bg-slate-700 rounded-2xl overflow-hidden shadow-lg">
                <div className="drag-handle absolute top-2 left-2 z-10 cursor-move text-slate-600 opacity-0 group-hover:opacity-100 transition">
                  <i className="fas fa-grip-vertical text-2xl"></i>
                </div>
                <button onClick={() => removeFile(i)} className="absolute top-2 right-2 z-10 bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                  <i className="fas fa-times"></i>
                </button>

                {previews[i] ? (
                  <img src={previews[i]} alt={file.name} className="w-full h-48 object-cover" />
                ) : (
                  <div className="w-full h-48 flex items-center justify-center bg-slate-200 dark:bg-slate-600">
                    <i className={`fa-solid ${file.type==='application/pdf' ? 'fa-file-pdf text-6xl text-red-500' : 'fa-file-image text-6xl text-green-500'}`}></i>
                  </div>
                )}

                <div className="p-3 text-center">
                  <p className="text-sm truncate font-medium">{file.name}</p>
                  <p className="text-xs text-slate-500">{formatBytes(file.size)}</p>
                </div>
              </div>
            ))}
          </div>

          {error && <p className="text-red-600 text-center mt-6 text-xl">{error}</p>}

          <button
            onClick={mergePDF}
            disabled={isMerging}
            className="w-full mt-10 bg-gradient-to-r from-blue-600 to-purple-600 disabled:from-slate-400 disabled:to-slate-500 text-white py-6 rounded-2xl text-2xl font-bold hover:shadow-2xl transition flex items-center justify-center"
          >
            {isMerging ? (
              <>Merging… <i className="fas fa-spinner fa-spin ml-4"></i></>
            ) : (
              <>Download Merged PDF <i className="fas fa-download ml-4"></i></>
            )}
          </button>
        </div>
      )}

      <p className="text-center mt-12">
        <a href="index.html" className="text-blue-600 hover:underline text-xl">
          ← Back to All Tools
        </a>
      </p>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
